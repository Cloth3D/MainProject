<!DOCTYPE html>
<html>
<head>
<meta name="viewport" charset="UTF-8"
	content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
<title>测试侧边栏</title>
<style>
body {
	margin: 0;
	overflow: hidden;
}

/* canvas { */
/* 	width: 100%; */
/* 	height: 100% */
/* } */

#ctrl {
	position: absolute;
	top: 200px;
	left: 0px;
	width: 300px;
	color: #555555;
	padding: 5px;
	font-family: Monospace;
	font-size: 13px;
	z-index: 100;
}
</style>

<link href='ui/sideBar.css' rel="stylesheet">

<script src='js/custom/Sidebar.js'></script>
<script src='js/custom/Sidebar.Material.js'></script>
<script src='js/custom/Sidebar.Object.js'></script>
<script src='js/signals.min.js'></script>

<script src='js/ui.js'></script>
<script src='js/ui.three.js'></script>

<script src='js/dat.gui.js'>
	// GUI框架
</script>
<script src='js/three.js'>
	// three.js框架
</script>
<script src='js/stats.min.js'>
	// 显示帧数
</script>
<script src='js/TrackballControls.js'>
	// 鼠标控制
</script>

<script src='js/loaders/AMFLoader.js'></script>
<script src='js/loaders/AWDLoader.js'></script>
<script src='js/loaders/BabylonLoader.js'></script>
<script src='js/loaders/ColladaLoader.js'></script>
<script src='js/loaders/FBXLoader.js'></script>
<script src='js/loaders/KMZLoader.js'></script>
<script src='js/loaders/MD2Loader.js'></script>
<script src='js/loaders/MTLLoader.js'></script>
<script src='js/loaders/OBJLoader.js'></script>
<script src='js/loaders/PlayCanvasLoader.js'></script>
<script src='js/loaders/PLYLoader.js'></script>
<script src='js/loaders/STLLoader.js'></script>
<script src='js/loaders/UTF8Loader.js'></script>
<script src='js/loaders/VRMLLoader.js'></script>
<script src='js/loaders/VTKLoader.js'></script>
<script src='js/loaders/ctm/ctm.js'></script>
<script src='js/loaders/ctm/CTMLoader.js'></script>
<script src='js/loaders/ctm/lzma.js'></script>

<script src='js/TransformControls.js'>
	// 控制移动的框架
</script>
<script src='js/SkeletonHelper.js'>
	// 显示骨骼的帮助
</script>
<script src='js/AnimationMixer.js'>
	// 动画
</script>
<script src='js/custom/Show.js'>
	// 封装
</script>
<script src="js/OrbitControls.js">
	// 轨道控制器
</script>
<script src='js/TransformControls.js'>
	// 移动控制器
</script>

<script src='js/custom/Loader.js'>
	// 用来加载模型文件
</script>
<script src='js/custom/transform.js'>
	// 用来控制移动
</script>
<script src='js/custom/MaterialTools.js'>
	// 添加贴图工具
</script>
<script src='js/custom/Human.js'>
	// 专门负责人体模型加载
</script>
<script src='js/custom/raycasting.js'>
	// 射线
</script>
<script src='js/custom/MergeAlphaMap.js'>
	// 合并贴图
</script>

<script src='js/command/Command.js'>
	// cmd
</script>
<script src='js/custom/History.js'>
	// 历史队列
</script>
<script src='js/command/AddObjectCommand.js'>
	// 添加模型cmd
</script>
<script src='js/command/RemoveObjectCommand.js'>
	// 移除模型cmd
</script>
<script src='js/command/SetPositionCommand.js'>
	// 移动位置
</script>
<script src='js/command/SetRotationCommand.js'>
	// 旋转
</script>
<script src='js/command/SetScaleCommand.js'>
	// 缩放值
</script>
<script src='js/command/SetMaterialColorCommand.js'>
	// 设置材质颜色
</script>
<script src='js/command/SetMaterialCommand.js'>
	// 替换新材质
</script>
<script src='js/command/SetMaterialMapCommand.js'>
	// 设置贴图
</script>
<script src='js/command/SetMaterialValueCommand.js'>
	// 设置材质参数
</script>
<script src='js/command/SetValueCommand.js'>
	// 设置值
</script>
<script src='js/command/SetColorCommand.js'>
	// 设置颜色
</script>

<script src='js/command/SetClothCommand.js'>
	// 穿衣服
</script>
<script src='js/command/SetFigureCommand.js'>
	// 体型变化
</script>
<script src = 'js/custom/XMLReader.js'></script>
<script src = 'js/command/UndressCommand.js'></script>
<script src = 'js/custom/MoveAndChooseManager.js'></script>

</head>
<body>

	<div id="ctrl">
		身高:<input type="range" value="0" min="0" max="100"
			onchange="show.execute(new SetFigureCommand(human1, value/100, 'height'));" /><br />
		肥胖:<input type="range" value="0" min="0" max="100"
			onchange="show.execute(new SetFigureCommand(human1, value/100, 'figure'));" /><br />
		<button onclick="fileInput.click();">读取模型</button>
		<br>
		<button
			onclick="show.execute(new RemoveObjectCommand(show.selected));">移除选中模型</button>
		<button onclick="trans.work();">停止移动工具</button>
		<br>
		<button onclick="addmaterial();">读取贴图测试</button>
		<br>
		<button onclick="loadhumantest();">加载人体模型测试</button>
		<br>
		<button onclick="loadUpCloth();">穿上衣测试</button>
		<br>
		<button onclick="human1.human.material.needsUpdate = true;">刷新材质测试</button>
		<br>
		<button onclick="playAni();">播放动画</button>
		<br>
		<button onclick="stopAni();">停止动画</button>
		<br>
		<button onclick="resetAni();">重置动画</button>
		<br>
		<button onclick="show.undo();">撤销</button>
		<button onclick="show.redo();">恢复</button>
		
		<br/>
		<button onclick = "wearCloth('cloth1', 'top');">上衣1</button>
		<button onclick = "wearCloth('cloth2', 'top');">上衣2</button>
		<button onclick = "wearCloth('cloth3', 'top');">上衣3</button>
		<button onclick = "wearCloth('cloth4', 'top');">上衣4</button>
		<button onclick = "wearCloth('cloth5', 'top');">上衣5</button>
		<button onclick = "undress('upcloth');">脱上衣</button>
		<br/>
		<button onclick = "wearCloth('cloth1', 'bottom');">下装1</button>
		<button onclick = "wearCloth('cloth2', 'bottom');">下装2</button>
		<button onclick = "wearCloth('cloth3', 'bottom');">下装3</button>
		<button onclick = "wearCloth('cloth4', 'bottom');">下装4</button>
		<button onclick = "wearCloth('cloth5', 'bottom');">下装5</button>
		<button onclick = "undress('trousers');">脱下装</button>
		<br/>
		<button onclick = "wearCloth('cloth1', 'shoes');">鞋子1</button>
		<button onclick = "wearCloth('cloth2', 'shoes');">鞋子2</button>
		<button onclick = "wearCloth('cloth3', 'shoes');">鞋子3</button>
		<button onclick = "wearCloth('cloth4', 'shoes');">鞋子4</button>
		<button onclick = "wearCloth('cloth5', 'shoes');">鞋子5</button>
		<button onclick = "undress('shoes');">脱鞋子</button>
		<br/>
		<button onclick = "wearCloth('cloth1', 'hair');">发型1</button>
		<button onclick = "wearCloth('cloth2', 'hair');">发型2</button>
		<button onclick = "wearCloth('cloth3', 'hair');">发型3</button>
		<button onclick = "wearCloth('cloth4', 'hair');">发型4</button>
		<button onclick = "wearCloth('cloth5', 'hair');">发型5</button>
		<button onclick = "undress('hair');">去发型</button>
		<br/>
		<button onclick = "wearCloth('cloth1', 'eyewear');">眼镜1</button>
		<button onclick = "wearCloth('cloth2', 'eyewear');">眼镜2</button>
		<button onclick = "wearCloth('cloth3', 'eyewear');">眼镜3</button>
		<button onclick = "undress('glasses');">摘眼镜</button>
		


	</div>
	<div id='div1'>
		<canvas id='canvas' width=window.innerWidth height=window.innerHeight>
你的浏览器不支持本应用
</canvas>
	</div>

	<script type="text/javascript">
		//这里用来存放一些全局变量
		var show; //封装
		var sidebar; // 侧边栏
		var canvas; // 画板
		var stats; // 帧数显示器
		var axes; // 坐标轴
		var clock; // 时钟和轨迹球控制器
		var dtrectionalLight; // 平行光线
		var gridHelper; // 网格助手
		var helper; // 显示骨骼的工具
		var fileInput; // 想办法进行文件输入
		var trans; // 移动控制器
		var human1; // 人体模型
		var myRayCaster; // 定义一个射线管理器
		var xmlDoc = checkXMLDocObj('model_path.xml');		// 读取xml文档
		var macm;			// 移动和选择管理
	</script>

	<script type="text/javascript">
		function onWindowResize() //重置窗口大小
		{
			show.onwindowresize(window.innerWidth, window.innerHeight); // 将canvas区域设置的window.inner那么大
		}

		function init() {
			show = new Show();
			show.init(window.innerWidth, window.innerHeight);

			sidebar = new Sidebar(show);
			document.body.appendChild(sidebar.dom);
			console.log(sidebar);
			sidebar.dom.hidden = false;
		}

		function addstats() // 添加状态显示模块，在init之后执行
		{
			stats = new Stats(); // 新建一个状态显示器
			stats.setMode(0); // 设置为默认显示fps
			// 设置stats的位置s
			stats.domElement.style.position = 'absolute';
			stats.domElement.style.left = '0px';
			stats.domElement.style.top = '0px';
			document.body.appendChild(stats.domElement); // 添加到页面中
		}

		function addListener() // 用来统一添加监听器
		{
			window.addEventListener('resize', onWindowResize, false); // 添加监听器，用来监听窗口变化
		}

		function addLight() // 添加光线
		{
			//directionalLight = new THREE.DirectionalLight(0xabfeff, 0.4);
			directionalLight = new THREE.DirectionalLight(0xffffff, 0.5);
			directionalLight.position.set(1, 1, 1); // 设置光线方向
			show.scene.add(directionalLight);
		}

		function addGrid() // 添加网格
		{
			var size = 10;
			var step = 0.5;
			gridHelper = new THREE.GridHelper(size, step); // 添加一个网格助手
			show.scene.add(gridHelper);
		}

		function render() {

			show.update(); // 渲染相机和场景
			stats.update(); // 更新
			if (trans)
				trans.update();
			if (human1)
				human1.update(human1);
			if (myRayCaster)
				myRayCaster.update(myRayCaster);

		}

		function animation() // 动画
		{
			requestAnimationFrame(animation); // 要求定时渲染
			render();
		}


		function addImport() {
			fileInput = document.createElement('input');
			fileInput.type = 'file';
			fileInput.addEventListener('change', function(event) {

				show.loader.loadFile(fileInput.files[0]);

			});
		}

		function loadhumantest() {			// 示例，使用xml存储human模型的地址
			human1 = new Human(show);
			var humanURL = gethumanURL(xmlDoc);
			human1.load( human1, 
					humanURL.body,
					humanURL.eyes,
					humanURL.eyelashes,
					humanURL.diffuse,
					humanURL.specular,
					humanURL.normal,
					humanURL.opacity,
					humanURL.lighting );
			human1.init(human1); // 添加到场景中

		}
		
		function wearCloth(cloth_id, cloth_type)		// 通过xml文件读取url
		{
			if(human1 == undefined)
			{
				loadhumantest();
				return;
			}
			
			 var cloth_url = getModelURL(xmlDoc, cloth_id, cloth_type);				// 获得某件衣服模型
			 //var cloth_opacity = getModelOpacityURL(xmlDoc, cloth_id, cloth_type);	// 只有 top, bottom, shoes有这句话
			 var cloth_opacity = undefined;
			 var human_cloth_type = '';
			 switch(cloth_type)		// 只有 top, bottom, shoes有这句话
			 {
			 case 'top':
			 		cloth_opacity = getModelOpacityURL(xmlDoc, cloth_id, cloth_type);
			 		human_cloth_type = 'upcloth';
			 		 break;
			 case 'bottom':
			 		cloth_opacity = getModelOpacityURL(xmlDoc, cloth_id, cloth_type);
			 		human_cloth_type = 'trousers';
			 		 break;
			 case 'shoes':
			 		cloth_opacity = getModelOpacityURL(xmlDoc, cloth_id, cloth_type);
			 		human_cloth_type = 'shoes';
			 		 break;
			 case 'hair':
			 		human_cloth_type = 'hair';
			 		 break;
			 case 'eyewear':
			 		human_cloth_type = 'glasses';
			 		 break;
			 }
			 
			 var cloth_mat = getMatURL(xmlDoc, cloth_id);			// 材质url

			 human1.CMDLoadCloth(									// 上衣
						human1,
						human_cloth_type,
						cloth_url,
						cloth_mat.diffuse,
						cloth_mat.specular,
						cloth_mat.normal,
						cloth_mat.opacity,
						cloth_mat.lighting,
						cloth_opacity
						);
		}
		
		function undress(cloth_type)		// 脱衣服的函数
		{
			show.execute(new UndressCommand(human1, cloth_type));
		}

		function playAni() {
			if (human1.mixer === null)
				human1.addMixer(human1);
			human1.clipaction.play();
			human1.play
		}

		function stopAni() {
			human1.clipaction.stop();
		}

		function resetAni() {
			human1.clipaction.reset();
		}
		
		function MACM() {	// 初始化MoveAndChooseManager
			macm = new MoveAndChooseManager(show);
		}

		function main() {
			init(); // 初始化窗口
			addListener() // 添加监听器
			addstats(); // 添加状态显示

			addLight(); // 添加光线
			addGrid(); // 添加网格
			animation(); // 调用动画
			addImport();
			
			MACM();
		}
		main(); //为了更清晰的理清逻辑，建立一个main函数,在窗口打开后执行一次
	</script>


</body>
</html>