<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>用来学习morphtarget</title>
<script type="text/javascript">
// try{
//     if (/Android|webOS|iPhone|iPod|BlackBerry/i.test(navigator.userAgent)) {
//         alert("您正在手机端访问本页面!")
//     }else{
//         alert("您正在电脑端访问本页面!");
//     }
// }catch(e){}
</script>

<style>
body {
	margin: 0;
	overflow: hidden;
}

canvas {
	width: 100%;
	height: 100%
}

#ctrl {
				position: absolute;
				top: 200px;
				left: 0px;
				width: 200px;
				color: #555555;
				padding: 5px;
				font-family: Monospace;
				font-size: 13px;
				z-index:100;
			}
			
</style>
</head>
<body>
<div id="ctrl">
			Use controls to change morph target influences:<br/>
			最胖  <input type="range" value="0" min="0" max="100" onchange="morph(this.value,0);" /><br/>
			臀大  <input type="range" value="0" min="0" max="100" onchange="morph(this.value,1);" /><br/>
			胸大  <input type="range" value="0" min="0" max="100" onchange="morph(this.value,2);" /><br/>
			腰粗  <input type="range" value="0" min="0" max="100" onchange="morph(this.value,3);" /><br/>
			<script >
			function morph(value,i)
			{
				mesh.traverse(function(child){
					if(child instanceof THREE.Mesh)
						{
							//alert(child.morphTargetInfluences.length);
							child.morphTargetInfluences[i] = value/100;
							//alert('模型是mesh类型的');
							//alert(child.geometry.morphTargets.length);
						}
				});
			}
			</script>
</div>
<div id = 'div1'>
<canvas id='canvas' width=window.innerWidth height=window.innerHeight>
你的浏览器不支持本应用
</canvas>
</div>
	<script src='js/dat.gui.js'>
	//GUI框架
	</script>
	<script src='js/three.js'>
	//three.js框架
	</script>
	<script src='js/stats.min.js'>
	//显示帧数
	</script>
	<script src='js/TrackballControls.js'>
	//鼠标控制
	</script>
	<script src='js/OBJLoader.js'>
	//用来加载obj模型
	</script>
	<script src='js/TransformControls.js'>
	//控制移动的框架
	</script>
	<script src = 'js/MTLLoader.js'></script>
	<script type="text/javascript">
	//这里用来存放一些全局变量
	
	var winWidth, winHeight;		// 画板的大小
	var canvas, scene, camera;		// 画板 场景 相机
	var renderer, stats;			// 渲染器及帧数显示器
	var axes ;						// 坐标轴
	var clock, cameraControls;		// 时钟和轨迹球控制器
	var dtrectionalLight;			// 平行光线
	var gridHelper;					// 网格助手
	var objloader;					// objloader
	var delta;						// 用来获取时间
	var control;					// 测试移动插件
	var mesh;
	</script>
<script type="text/javascript">
function onWindowResize() //重置窗口大小
{
	camera.aspect = window.innerWidth / window.innerHeight;			// 重置相机比例
	camera.updateProjectionMatrix();								//

	renderer.setSize(window.innerWidth, window.innerHeight);		// 重置渲染的大小
	
	doucument.getElementById('canvas').width = window.innerWidth;	
	doucument.getElementById('canvas').height = window.innerHeight;
}

function init()
{
	canvas=document.getElementById('canvas');					// 创建一个canvas
	scene = new THREE.Scene();									// 创建一个scene
	camera = new THREE.PerspectiveCamera( 75, window.innerWidth / window.innerHeight, 0.1, 1000 );	// 创建相机
	// 设置相机初始位置，使其正对着模型
	camera.position.z = 3;
	camera.position.x = 0;
	camera.position.y = 1.5;
	
	renderer = new THREE.WebGLRenderer({canvas:document.getElementById('canvas'),
		antialias:true,
		precision:THREE.highp });					//创建一个渲染器
	renderer.setSize( window.innerWidth, window.innerHeight );		//设置渲染器渲染范围
	renderer.setClearColor(0xEEEEEE);
}

function addstats()		// 添加状态显示模块，在init之后执行
{
	stats = new Stats();									// 新建一个状态显示器
	stats.setMode(0);										// 设置为默认显示fps
	// 设置stats的位置s
	stats.domElement.style.position = 'absolute';
	stats.domElement.style.left = '0px';
	stats.domElement.style.top	 = '0px';
	document.body.appendChild(stats.domElement);			// 添加到页面中
}

function addListener()		// 用来统一添加监听器
{
	window.addEventListener('resize', onWindowResize, false);	// 添加监听器，用来监听窗口变化
// 	window.addEventListener( 'keydown', function ( event ) {

// 		switch ( event.keyCode ) {

// 			case 81: // Q
// 				control.setSpace( control.space === "local" ? "world" : "local" );
// 				break;

// 			case 17: // Ctrl
// 				control.setTranslationSnap( 100 );
// 				control.setRotationSnap( THREE.Math.degToRad( 15 ) );
// 				break;

// 			case 87: // W
// 				control.setMode( "translate" );
// 				break;

// 			case 69: // E
// 				control.setMode( "rotate" );
// 				break;

// 			case 82: // R
// 				control.setMode( "scale" );
// 				break;

// 			case 187:
// 			case 107: // +, =, num+
// 				control.setSize( control.size + 0.1 );
// 				break;

// 			case 189:
// 			case 109: // -, _, num-
// 				control.setSize( Math.max( control.size - 0.1, 0.1 ) );
// 				break;

// 		}

// 	});

// 	window.addEventListener( 'keyup', function ( event ) {

// 		switch ( event.keyCode ) {

// 			case 17: // Ctrl
// 				control.setTranslationSnap( null );
// 				control.setRotationSnap( null );
// 				break;

// 		}

// 	});

}


function addTrackball()		// 用来添加轨迹球控制器
{
	// TrackballControls 设置一个轨迹球操作器
	clock = new THREE.Clock();
	cameraControls = new THREE.TrackballControls(camera,renderer.domElement);			// 定义相机控制器
	cameraControls.target.set(0, 1, 0);													// 设置中心点坐标
	cameraControls.zoomSpeed = 1.0;								// 设置缩放速度
	cameraControls.rotateSpeed = 1.0;
	cameraControls.panSpeed = 1.0;
	cameraControls.noPan = true;								// 不让移动
	cameraControls.dynamicDampingFactor = 0.5;					// 设置阻尼效果，可以改变鼠标拖动时操作的灵敏度
	cameraControls.minDistance = 2.0;							// 设置最近距离，可以使相机不要过分的接近
	cameraControls.maxDistance = 10.0;							// 设置最远距离，可以使相机不要过分的远离
}

function addTransform()			// 添加移动帮助
{
	control = new THREE.TransformControls( camera, renderer.domElement );	// 构造函数
	//control.addEventListener( 'change', animation );						
	
	var geometry = new THREE.BoxGeometry( 200, 200, 200 );
	var material = new THREE.MeshLambertMaterial( { Color: 0xff0000 } );
	var mesh = new THREE.Mesh( geometry, material );
	scene.add( mesh );

	control.attach( mesh );
	scene.add( control );
}

function addLight()			// 添加光线
{
	directionalLight = new THREE.DirectionalLight(0xffffff, 0.5);
	directionalLight.position.set(1,1, 1);						// 设置光线方向
	//directionalLight.shadowCameraVisble = true;
	scene.add(directionalLight);
}

function addGrid()			// 添加网格
{
	var size = 10;
	var step = 0.5;
	gridHelper = new THREE.GridHelper(size, step);		// 添加一个网格助手
	scene.add(gridHelper);
}
function load()				// 读取模型
{
	loader = new THREE.OBJLoader();
	//alert("准备加载模型");
	//load a resource
	loader.load('models/nakeBody/nakeBody.obj', function(loadedMesh) {
		var material = new THREE.MeshLambertMaterial({
			color : 0xaaaaaa
		});
		loadedMesh.children.forEach(function(child) {
			child.material = material;
			child.geometry.computeFaceNormals();
			child.geometry.computeVertexNormals();
		});
		mesh = loadedMesh;
		mesh.name = 'nakeBody';				// 尝试给模型添加名称
		mesh.scale.set(0.1, 0.1, 0.1);
		scene.add(mesh);
		mesh.updateMorphTargets();			// 更新
	});
	//alert("模型加载完成");
}

function load_new()
{
	  mesh = null;
	
  	  var objLoaderTarget = new THREE.OBJLoader();
  	  var geo = [];
  	  
  	  objLoaderTarget.setPath('models/Body_bianxing-0412/');
  	  
  	  objLoaderTarget.load('Body_160zuipang0412.obj',function(object){		// 最胖的人体模型  
  		 object.scale.set(3,3,3);
  	     geo[0] = new Array();	// 为该位置创建新数组
  		 object.traverse(function(child){		// 遍历
  			 //alert(i++);
  			 if(child instanceof THREE.Mesh)
  				 {
  				 	if(child.geometry instanceof THREE.BufferGeometry)		// 因为需要提取出来Vector3[] ,所以不能使用bufferGeometry
  				 		{
  				 		//child.scale.set(3,3,3);
  				 		var geometry = new THREE.Geometry().fromBufferGeometry( child.geometry );		// 将bufferGeometry转化为Geometry
  				 		geo[0].push(geometry.vertices);
  				 		}
  				 	//else	alert('fail geometry');
  				 }
  			 //else	alert('fail mesh');
  		 }) ;
  	  //alert(geo[0].length);
  	  //alert(object.children.length);
  		// alert(geo.length);			// 得到geo数组的长度
  	  });		// objloader
  	  
  	objLoaderTarget.load('Body_160tunda0412.obj',function(object){	 		// 臀大的人体模型 
  		 geo[1] = new Array();	// 为该位置创建新数组
  		 object.scale.set(3,3,3);
 		 object.traverse(function(child){									// 遍历
 			 if(child instanceof THREE.Mesh)
 				 {
 				 	if(child.geometry instanceof THREE.BufferGeometry)		// 因为需要提取出来Vector3[] ,所以不能使用bufferGeometry
 				 		{
 				 		var geometry = new THREE.Geometry().fromBufferGeometry( child.geometry );		// 将bufferGeometry转化为Geometry
 				 		geo[1].push(geometry.vertices);
 				 		}
 				 }
 		 }) ;
 		// alert(geo.length);			// 得到geo数组的长度
 	  });		// objloader
  	  
 	 objLoaderTarget.load('Body_160xiongda0412.obj',function(object){	 		// 臀大的人体模型 
 		 geo[2] = new Array();	// 为该位置创建新数组
 		 object.scale.set(3,3,3);
 		 object.traverse(function(child){
 			 if(child instanceof THREE.Mesh)
 				 {
 				 	if(child.geometry instanceof THREE.BufferGeometry)		// 因为需要提取出来Vector3[] ,所以不能使用bufferGeometry
 				 		{
 				 		var geometry = new THREE.Geometry().fromBufferGeometry( child.geometry );		// 将bufferGeometry转化为Geometry
 				 		geo[2].push(geometry.vertices);
 				 		}
 				 }
 		 }) ;
 		// alert(geo.length);			// 得到geo数组的长度
 	  });		// objloader
 	  
 	 objLoaderTarget.load('Body_160yaoda0412.obj',function(object){	 		// 臀大的人体模型 
 		 geo[3] = new Array();	// 为该位置创建新数组
 		 object.scale.set(3,3,3);
 		 object.traverse(function(child){
 			 if(child instanceof THREE.Mesh)
 				 {
 				 	if(child.geometry instanceof THREE.BufferGeometry)		// 因为需要提取出来Vector3[] ,所以不能使用bufferGeometry
 				 		{
 				 		var geometry = new THREE.Geometry().fromBufferGeometry( child.geometry );		// 将bufferGeometry转化为Geometry
 				 		geo[3].push(geometry.vertices);
 				 		}
 				 }
 		 }) ;
 		 //alert(geo[3].length);			// 得到geo数组的长度
 	  });		// objloader
 	  
	  var objLoader = new THREE.OBJLoader();
	  objLoader.setPath( "models/Body_bianxing-0412/" );
	  objLoader.load( 'Body_160zuishou0412.obj', function ( object) {
		  var j = 0;									// 每个模型的序列
		  mesh = new THREE.Group();						// 新建一个mesh
		  object.traverse(function(child) {			    // 遍历
			    if(child instanceof THREE.Mesh)			// 这么做的原因是原来的Mesh是用bufferGeometry生成的，缺少了一些属性，必须重新生成。
			    	{
						var geometry  = new THREE.Geometry().fromBufferGeometry(child.geometry);	// 将读取的Mesh转化为THREE.Geometry类型
						for(var i = 0;i < geo.length; i++)
						{
							geometry.morphTargets.push({name:'fat',vertices:geo[i][j]});			// 将肥胖的坐标给添加进去
						}
						j++;			// 下一个模型
						mesh.add(new THREE.Mesh(geometry, new THREE.MeshLambertMaterial({
							color:0x999999, morphTargets: true
						})));	// add
			    	}		// if
			});				// traverse
		// alert(mesh.children.length);
	    mesh.scale.set(3,3,3);
	    mesh.position.y = 0;
	    scene.add( mesh );
	  });		// OBJLoader

}

function render() 
{
	
	renderer.render( scene, camera );					// 渲染相机和场景
	stats.update();										// 更新
		
}

function cameraCtrl()
{
	delta = clock.getDelta();							// 获取时间
	cameraControls.update(delta);						// 更新
}

function animation()			// 动画
{
	requestAnimationFrame( animation );					// 要求定时渲染
	render();
	cameraCtrl();										// 鼠标控制
	//control.update();
}


</script>
<script type="text/javascript">
function main()
{
	init();					// 初始化窗口
	addListener()			// 添加监听器
	addstats();				// 添加状态显示
	addTrackball();			// 添加轨迹球控制器
	load_new();					// 添加模型
	addLight();				// 添加光线
	addGrid();				// 添加网格
	animation();			// 调用动画
	//addTransform();			// 添加移动帮助
	
}
main();						//为了更清晰的理清逻辑，建立一个main函数,在窗口打开后执行一次
</script>
</body>
</html>